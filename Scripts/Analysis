# ====================== AN√ÅLISIS GENERAL DE MUTACIONES ==============================

gene_summary <- getGeneSummary(luad_maf) %>% arrange(desc(AlteredSamples))
genes_of_interest <- c("EGFR", "KRAS") #Filtro por mis dos genes de interes ya que el an√°lisis total puede ser muy pesado

maf_dt_clean <- luad_maf@data %>%
  as.data.frame(stringsAsFactors = FALSE) %>%
  dplyr::select(Hugo_Symbol, Tumor_Sample_Barcode) %>%
  dplyr::distinct()

colnames(maf_dt_clean)

egfr_samples <- maf_dt_clean %>%
  filter(Hugo_Symbol == "EGFR") %>%
  pull(Tumor_Sample_Barcode) %>%
  unique() %>% sort()

kras_samples <- maf_dt_clean %>%
  filter(Hugo_Symbol == "KRAS") %>%
  pull(Tumor_Sample_Barcode) %>%
  unique() %>% sort()

cat("N√∫mero de muestras con mutaciones EGFR:", length(egfr_samples), "\n")
cat("N√∫mero de muestras con mutaciones KRAS:", length(kras_samples), "\n")

write.csv(data.frame(EGFR_samples = egfr_samples),
          file = file.path(output_dir, "EGFR_mutated_samples_LUAD.csv"),
          row.names = FALSE)

write.csv(data.frame(KRAS_samples = kras_samples),
          file = file.path(output_dir, "KRAS_mutated_samples_LUAD.csv"),
          row.names = FALSE)

egfr_maf <- subsetMaf(maf = luad_maf, tsb = egfr_samples, mafObj = TRUE)
kras_maf <- subsetMaf(maf = luad_maf, tsb = kras_samples, mafObj = TRUE)

comp_res <- mafCompare(m1 = egfr_maf,
                       m2 = kras_maf,
                       m1Name = "EGFR_mut",
                       m2Name = "KRAS_mut",
                       minMut = 3)

write.csv(comp_res$results,
          file = file.path(output_dir, "EGFR_vs_KRAS_mafCompare_results.csv"),
          row.names = FALSE)

total_samples <- unique(luad_maf@clinical.data$Tumor_Sample_Barcode) %>% length()

freq_table <- data.frame(
  Gene = genes_of_interest,
  AlteredSamples = c(length(egfr_samples), length(kras_samples)),
  Percent = c(length(egfr_samples), length(kras_samples)) / total_samples * 100,
  Total_Samples = total_samples
)

write.csv(freq_table,
          file = file.path(output_dir, "EGFR and KRAS mutation frequencies in LUAD.csv"),
          row.names = FALSE)

# Coocurrencia
onc_matrix <- maftools::oncoplot(maf = luad_maf, writeMatrix = TRUE)$oncoMatrix

if (all(genes_of_interest %in% rownames(onc_matrix))) {
  egfr_kras_matrix <- onc_matrix[genes_of_interest, , drop = FALSE]
  total_samples <- ncol(egfr_kras_matrix)
  egfr_pos <- colSums(egfr_kras_matrix["EGFR", , drop = FALSE] != 0) > 0
  kras_pos <- colSums(egfr_kras_matrix["KRAS", , drop = FALSE] != 0) > 0
  both <- sum(egfr_pos & kras_pos)
  only_egfr <- sum(egfr_pos & !kras_pos)
  only_kras  <- sum(kras_pos & !egfr_pos)
  neither     <- total_samples - (both + only_egfr + only_kras)
  co_table <- data.frame(Condition = c("Both", "Only_EGFR", "Only_KRAS", "Neither"),
                         Count = c(both, only_egfr, only_kras, neither))
  write.csv(co_table,
            file = file.path(output_dir, "EGFR_KRAS_cooccurrence_LUAD.csv"),
            row.names = FALSE)
}

saveRDS(egfr_maf, file = file.path(output_dir, "EGFR_subset_maf_LUAD.rds"))
saveRDS(kras_maf, file = file.path(output_dir, "KRAS_subset_maf_LUAD.rds"))



# Revisi√≥n de datos guardados
# Resumen general de mutaciones (todo el objeto Maf)
luad_maf <- readRDS(file.path(output_dir, "EGFR_subset_maf_LUAD.rds")) 
print(luad_maf)
View(luad_maf)

# ====================== COMPARACI√ìN DE PERFILES MUTACIONALES ===============================

# Genes mutados entre EGFR y KRAS (top 15)
comp_res <- read.csv(file.path(output_dir, "EGFR_vs_KRAS_mafCompare_results.csv"))
knitr::kable(head(comp_res, 15), caption = "Genes mutados entre EGFR y KRAS (top 15)")

# Resumen de  tipos de mutaci√≥n # Excluyendo long genes o FLAG genes

get_mutation_summary <- function(maf_obj) {
  
  df <- maf_obj@data %>%
    as.data.frame(stringsAsFactors = FALSE)
  
  # Tipos de mutaci√≥n que quieres incluir
  mutation_types <- c(
    "Frame_Shift_Del",
    "Frame_Shift_Ins",
    "In_Frame_Del",
    "In_Frame_Ins",
    "Missense_Mutation",
    "Nonsense_Mutation",
    "Nonstop_Mutation",
    "Splice_Site",
    "Translation_Start_Site"
  )
  
  summary_df <- df %>%
    filter(Variant_Classification %in% mutation_types) %>%
    group_by(Variant_Classification) %>%
    summarise(Count = n()) %>%
    mutate(
      Percent = round(Count / sum(Count) * 100, 2)
    ) %>%
    arrange(desc(Count))
  
  return(summary_df)
}


# Aplicar a KRAS y EGFR filtrados

egfr_summary <- get_mutation_summary(maf_egfr_filt)
kras_summary <- get_mutation_summary(maf_kras_filt)
no_egfr_no_kras_summary <- get_mutation_summary(maf_none_filt)

# Resultados
egfr_summary
kras_summary
no_egfr_no_kras_summary

# An√°lisis de Mutaciones seg√∫n por el codon especifico mutado
# solo mutaciones con ‚â•5 ocurrencias, porque hay muchas mutaciones raras y se solapan

# Recargar y normalizar el objeto MAF (luad_maf)

luad_maf <- TCGAmutations::tcga_load(study = "LUAD")

print("Resumen general del MAF LUAD:")
print(luad_maf)
mafSummary(luad_maf)
# Normalizamos el campo de los nombres de los genes
luad_maf@data$Hugo_Symbol <- trimws(toupper(luad_maf@data$Hugo_Symbol))

# Corregimos posibles variantes del nombre de KRAS (por ejemplo "K-RAS")
luad_maf@data$Hugo_Symbol[luad_maf@data$Hugo_Symbol %in% c("K-RAS", "K RAS")] <- "KRAS"

# Confirmar que KRAS ahora s√≠ est√° presente y contar mutaciones
cat("Mutaciones encontradas para KRAS:\n")
table(luad_maf@data$Hugo_Symbol)[grep("KRAS", names(table(luad_maf@data$Hugo_Symbol)))]

# Subset del MAF solo con EGFR y KRAS

egfr_kras <- subsetMaf(luad_maf, genes = c("EGFR", "KRAS"), mafObj = FALSE)

# Aseguramos formato data.frame para dplyr
egfr_kras <- as.data.frame(egfr_kras)

# Limpieza y conteo de mutaciones por gen y cod√≥n

mut_summary <- egfr_kras %>%
  dplyr::select(Hugo_Symbol, HGVSp_Short) %>%
  dplyr::mutate(
    Codon = gsub("^p\\.", "", HGVSp_Short)
  )

# Contar frecuencia y calcular porcentaje
freq_table <- mut_summary %>%
  group_by(Hugo_Symbol, Codon) %>%
  summarise(Count = n(), .groups = "drop") %>%
  mutate(Percent = 100 * Count / sum(Count)) %>%
  filter(Count >= 5)   # mostrar solo mutaciones con ‚â•5 ocurrencias

# Mostrar resumen 
freq_table %>% arrange(desc(Count))



# ====================== ANALISIS DE EXPRESI√ìN G√âNICA (RNA-seq) de TCGA-LUAD ===================

# Cargar subsets (EGFR y KRAS) creados antes

output_dir <- "/Users/kissyguevara/Desktop/MASTER/TFM/Datos R"

egfr_only <- readRDS(file.path(output_dir, "LUAD_subset_EGFR_only.rds"))
kras_only <- readRDS(file.path(output_dir, "LUAD_subset_KRAS_only.rds"))

egfr_samples <- unique(egfr_only@data$Tumor_Sample_Barcode)
kras_samples <- unique(kras_only@data$Tumor_Sample_Barcode)

cat("EGFR samples:", length(egfr_samples), "\n")
cat("KRAS samples:", length(kras_samples), "\n")


# Descargar datos de expresi√≥n g√©nica (RNA-seq) de TCGA-LUAD

query_exp <- GDCquery(
  project = "TCGA-LUAD",
  data.category = "Transcriptome Profiling",
  data.type = "Gene Expression Quantification",
  workflow.type = "STAR - Counts" 
)

GDCdownload(query_exp)
data_exp <- GDCprepare(query = query_exp)

# Preparar matriz de expresi√≥n y metadatos

exp_matrix <- assay(data_exp)
metadata <- colData(data_exp)

# Convertir nombres de columnas (muestras) al formato TCGA est√°ndar (15 caracteres)
colnames(exp_matrix) <- substr(colnames(exp_matrix), 1, 15)


# Filtrar muestras EGFR vs KRAS

egfr_exp <- exp_matrix[, colnames(exp_matrix) %in% substr(egfr_samples, 1, 15)]
kras_exp <- exp_matrix[, colnames(exp_matrix) %in% substr(kras_samples, 1, 15)]

cat("Muestras con datos de expresi√≥n - EGFR:", ncol(egfr_exp), "\n")
cat("Muestras con datos de expresi√≥n - KRAS:", ncol(kras_exp), "\n")


# An√°lisis diferencial con DESeq2 (EGFR vs KRAS)

if (!requireNamespace("DESeq2", quietly = TRUE)) BiocManager::install("DESeq2")
library(DESeq2)

# Crear un objeto con solo las muestras de inter√©s
common_genes <- intersect(rownames(egfr_exp), rownames(kras_exp))
combined_exp <- cbind(egfr_exp[common_genes, ], kras_exp[common_genes, ])
group <- factor(c(rep("EGFR", ncol(egfr_exp)), rep("KRAS", ncol(kras_exp))))

dds <- DESeqDataSetFromMatrix(
  countData = round(combined_exp),
  colData = data.frame(group),
  design = ~ group
)

dds <- DESeq(dds)
res <- results(dds)

# Ordenar por significancia
res_ordered <- res[order(res$padj), ]

# Guardar resultados
write.csv(as.data.frame(res_ordered),
          file = file.path(output_dir, "DEG_EGFR_vs_KRAS_LUAD.csv"),
          row.names = TRUE)

cat("Resultados guardados en DEG_EGFR_vs_KRAS_LUAD.csv\n")

# Convertir a data frame para ver mejor los diferenciados 
res_df <- as.data.frame(res)

# Filtrar genes con padj < 0.05
deg_signif <- res_df[!is.na(res_df$padj) & res_df$padj < 0.05, ]

# N√∫mero total de genes diferencialmente expresados
cat("N√∫mero de genes diferencialmente expresados (padj < 0.05):", nrow(deg_signif), "\n")

# separar en regulados positivamente y negativamente
upregulated <- deg_signif[deg_signif$log2FoldChange > 0, ]
downregulated <- deg_signif[deg_signif$log2FoldChange < 0, ]

cat("Genes sobreexpresados en EGFR vs KRAS:", nrow(upregulated), "\n")
cat("Genes subexpresados en EGFR vs KRAS:", nrow(downregulated), "\n")

# Top 15 genes diferenciales

# Convertir rownames a IDs de Ensembl sin versi√≥n
gene_ids <- gsub("\\..*", "", rownames(res_ordered))

# Mapear a s√≠mbolos de genes
gene_symbols <- mapIds(
  org.Hs.eg.db,
  keys = gene_ids,
  column = "SYMBOL",
  keytype = "ENSEMBL",
  multiVals = "first"
)

# Agregar s√≠mbolos a la tabla de resultados
res_ordered$symbol <- gene_symbols

# Filtrar genes significativos (padj < 0.05)
deg_signif <- res_ordered[!is.na(res_ordered$padj) & res_ordered$padj < 0.05, ]

# Excluir genes sin s√≠mbolo
deg_signif <- deg_signif[!is.na(deg_signif$symbol), ]

# Ordenar por padj
deg_signif <- deg_signif[order(deg_signif$padj), ]

# Seleccionar top 15
top15_named <- deg_signif[1:15, c("symbol", "log2FoldChange", "pvalue", "padj")]

# Agregar columna de regulaci√≥n
top15_named$Regulation <- ifelse(top15_named$log2FoldChange > 0, "Sobreexpresado", "Subexpresado")

# Mostrar tabla
print(top15_named)


# Mejor visualizaci√≥n en tabla (Tabla 1) 
if (requireNamespace("knitr", quietly = TRUE)) {
  knitr::kable(top15_named, caption = "Top 15 genes m√°s diferencialmente expresados (EGFR vs KRAS)")
}

# Guardar
write.csv(top15_named, "Top15_DEGs_EGFR_vs_KRAS.csv", row.names = FALSE)
saveRDS(dds, file = file.path(output_dir, "DESeq2_EGFR_vs_KRAS_LUAD.rds"))

# Continuaci√≥n clusterprofiler

Cargar DEGs desde DESeq2

deg <- read.csv("DEG_EGFR_vs_KRAS_LUAD.csv", row.names = 1)

# Filtrar genes significativos
deg_sig <- deg[!is.na(deg$padj) & deg$padj < 0.05, ]

# Extraer ENSG limpio (sin versi√≥n)
deg_sig$ensembl_clean <- gsub("\\..*", "", rownames(deg_sig))


# Dividir en genes up (EGFR‚Üë) y down (KRAS‚Üë)

up_genes <- deg_sig$ensembl_clean[deg_sig$log2FoldChange > 0]
down_genes <- deg_sig$ensembl_clean[deg_sig$log2FoldChange < 0]

cat("Genes up (EGFR):", length(up_genes), "\n")
cat("Genes down (KRAS):", length(down_genes), "\n")

# Convertir ENSG ‚Üí ENTREZ (clusterProfiler lo requiere)

up_entrez <- bitr(up_genes,
                  fromType = "ENSEMBL",
                  toType = "ENTREZID",
                  OrgDb = org.Hs.eg.db)

down_entrez <- bitr(down_genes,
                    fromType = "ENSEMBL",
                    toType = "ENTREZID",
                    OrgDb = org.Hs.eg.db)

# Enriquecimiento GO (BP) y KEGG

ego_up <- enrichGO(gene = up_entrez$ENTREZID,
                   OrgDb = org.Hs.eg.db,
                   keyType = "ENTREZID",
                   ont = "BP",
                   pAdjustMethod = "BH")

ego_down <- enrichGO(gene = down_entrez$ENTREZID,
                     OrgDb = org.Hs.eg.db,
                     keyType = "ENTREZID",
                     ont = "BP",
                     pAdjustMethod = "BH")

kegg_up <- enrichKEGG(gene = up_entrez$ENTREZID,
                      organism = "hsa")

kegg_down <- enrichKEGG(gene = down_entrez$ENTREZID,
                        organism = "hsa")

# Guardar resultados
write.csv(as.data.frame(ego_up), "GO_EGFR_upregulated.csv")
write.csv(as.data.frame(ego_down), "GO_KRAS_upregulated.csv")
write.csv(as.data.frame(kegg_up), "KEGG_EGFR_upregulated.csv")
write.csv(as.data.frame(kegg_down), "KEGG_KRAS_upregulated.csv")

cat("An√°lisis completado y guardado.\n")


# ====================== AN√ÅLISIS DE PROTE√çNAS TCGA RPPA ======================================

# Crear vector de grupos 

sample_group <- rppa_subset %>%
  dplyr::mutate(Group = dplyr::case_when(
    short_id %in% egfr_short ~ "EGFR",
    short_id %in% kras_short ~ "KRAS",
    TRUE ~ NA_character_
  )) %>%
  dplyr::select(short_id, Group)

rownames(sample_group) <- sample_group$short_id

# Convertir sample_id a rownames y eliminar short_id
rppa_mat <- rppa_subset %>%
  tibble::column_to_rownames(var = "sample_id") %>%
  dplyr::select(-short_id) %>%   # elimina short_id
  as.matrix()

# Reemplazar NA/Inf por 0
rppa_mat[!is.finite(rppa_mat)] <- 0


# Calcular las prote√≠nas m√°s variables
# Subset top 30 prote√≠nas m√°s variables
protein_var <- apply(rppa_mat, 2, sd, na.rm = TRUE)
top_proteins <- names(sort(protein_var, decreasing = TRUE))[1:30]
rppa_top <- rppa_mat[, top_proteins, drop = FALSE]

# rppa_mat: filas = muestras, columnas = prote√≠nas
# sample_group: data.frame fila=muestra, columna=Group


# Calcular medias por grupo (EGFR vs KRAS)

group_df <- data.frame(
  Sample = rownames(rppa_mat),
  Group = sample_group$Group
)

# Crear un data frame con las medias por grupo
mean_by_group <- sapply(top_proteins, function(prot) {
  egfr_mean <- mean(rppa_mat[group_df$Group == "EGFR", prot], na.rm = TRUE)
  kras_mean <- mean(rppa_mat[group_df$Group == "KRAS", prot], na.rm = TRUE)
  c(EGFR_Mean = egfr_mean, KRAS_Mean = kras_mean)
})

mean_by_group <- as.data.frame(t(mean_by_group))


# Calcular log2FC y asignar grupo predominante

mean_by_group$log2FC <- log2(mean_by_group$EGFR_Mean / mean_by_group$KRAS_Mean)
mean_by_group$Regulation <- ifelse(mean_by_group$log2FC > 0,
                                   "M√°s alta en EGFR",
                                   "M√°s alta en KRAS")


#  Mostrar resultados ordenados

mean_by_group <- mean_by_group[order(abs(mean_by_group$log2FC), decreasing = TRUE), ]
print(mean_by_group)

# Guardar tabla en CSV (Anexo 1)

write.csv(mean_by_group,
          file = file.path(output_dir, "Top30_Proteins_EGFR_KRAS_mean_by_group.csv"),
          row.names = TRUE)

# Calcular Significancia
#  Realizar test estad√≠stico (t-test) para cada prote√≠na

results_list <- lapply(top_proteins, function(prot) {
  data_tmp <- data.frame(
    Expression = rppa_mat[, prot],
    Group = group_df$Group
  )
  test <- t.test(Expression ~ Group, data = data_tmp)
  data.frame(
    Protein = prot,
    Mean_EGFR = mean(data_tmp$Expression[data_tmp$Group == "EGFR"], na.rm = TRUE),
    Mean_KRAS = mean(data_tmp$Expression[data_tmp$Group == "KRAS"], na.rm = TRUE),
    log2FC = log2(mean(data_tmp$Expression[data_tmp$Group == "EGFR"], na.rm = TRUE) /
                  mean(data_tmp$Expression[data_tmp$Group == "KRAS"], na.rm = TRUE)),
    p_value = test$p.value
  )
})

protein_stats <- do.call(rbind, results_list)

#  Ajustar p-valores por FDR (correcci√≥n de Benjamini-Hochberg)

protein_stats$padj <- p.adjust(protein_stats$p_value, method = "BH")

#  Determinar direcci√≥n (sobreexpresada en EGFR o KRAS)

protein_stats$Regulation <- ifelse(protein_stats$log2FC > 0, "Sobreexpresada en EGFR", "Sobreexpresada en KRAS")

#  Filtrar prote√≠nas significativas (padj < 0.05)

signif_proteins <- subset(protein_stats, padj < 0.05)


# Mostrar resultados ordenados por significancia

signif_proteins <- signif_proteins[order(signif_proteins$padj), ]
print(signif_proteins)

#  Guardar 
write.csv(signif_proteins,
          file = file.path(output_dir, "RPPA_DE_Proteins_EGFR_vs_KRAS.csv"),
          row.names = FALSE)


# ====================== AN√ÅLISIS DE RNAseq ======================================

# Resumen estad√≠stico b√°sico por gen

for (gene in rownames(seu_subset)) {
  cat("\nüìä Expresi√≥n resumida para", gene, ":\n")
  expr_vals <- as.numeric(GetAssayData(seu_subset, slot = "counts")[gene, ])
  print(summary(expr_vals))
  cat("C√©lulas con expresi√≥n > 0:", sum(expr_vals > 0), "\n")
}

# Comparaci√≥n num√©rica entre EGFR y KRAS

counts_mat <- GetAssayData(seu_subset, slot = "counts")

expr_df <- data.frame(
  Cell = colnames(counts_mat),
  EGFR = as.numeric(counts_mat["EGFR", ]),
  KRAS = as.numeric(counts_mat["KRAS", ])
)

expr_summary <- expr_df %>%
  summarise(
    mean_EGFR = mean(EGFR),
    mean_KRAS = mean(KRAS),
    median_EGFR = median(EGFR),
    median_KRAS = median(KRAS),
    prop_EGFR_pos = mean(EGFR > 0),
    prop_KRAS_pos = mean(KRAS > 0)
  )

cat("\nüìà Resumen comparativo entre EGFR y KRAS:\n")
print(expr_summary)


# Contnuaci√≥n an√°lisis Single cell
genes_interes <- c("EGFR", "KRAS")

# Extraer expresi√≥n normalizada (slot "data") para los genes de inter√©s
expr_mat <- GetAssayData(seu_subset, assay = "RNA", slot = "data")[genes_interes, ]

# Determinar c√©lulas positivas para cada gen
egfr_cells <- colnames(expr_mat)[expr_mat["EGFR", ] > 0]
kras_cells <- colnames(expr_mat)[expr_mat["KRAS", ] > 0]

# Crear columna "Group" en metadata
seu_subset$Group <- NA
seu_subset$Group[colnames(seu_subset) %in% egfr_cells] <- "EGFR"
seu_subset$Group[colnames(seu_subset) %in% kras_cells] <- "KRAS"

table(seu_subset$Group)

rppa_long <- as.data.frame(expr_mat) %>%
  rownames_to_column(var = "Gene") %>%
  pivot_longer(
    cols = -Gene,
    names_to = "Cell",
    values_to = "Expression"
  )

# A√±adir columna Group
rppa_long <- merge(rppa_long,
                   data.frame(Cell = colnames(seu_subset),
                              Group = seu_subset$Group),
                   by = "Cell",
                   all.x = TRUE)

# Resumen estad√≠stico
summary_stats <- rppa_long %>%
  group_by(Gene, Group) %>%
  summarise(
    mean_expr = mean(Expression, na.rm = TRUE),
    median_expr = median(Expression, na.rm = TRUE),
    prop_pos = sum(Expression > 0)/n(),
    .groups = "drop"
  )
print(summary_stats)



# ====================== AN√ÅLISIS DE SUPERVIVENCIA TCGA ======================================

# Cargar MAF de LUAD
luad_maf <- tcga_load(study = "LUAD")

maf_dt_clean <- as.data.frame(luad_maf@data, stringsAsFactors = FALSE) %>%
  distinct(Hugo_Symbol, Tumor_Sample_Barcode)

# Identificar mutaciones EGFR / KRAS
egfr_samples <- maf_dt_clean %>%
  filter(Hugo_Symbol == "EGFR") %>%
  pull(Tumor_Sample_Barcode) %>% unique()

kras_samples <- maf_dt_clean %>%
  filter(Hugo_Symbol == "KRAS") %>%
  pull(Tumor_Sample_Barcode) %>% unique()

# Extraer datos cl√≠nicos y de supervivencia
clin_df <- luad_maf@clinical.data

clin_df$Group <- "None"
clin_df$Group[clin_df$Tumor_Sample_Barcode %in% egfr_samples] <- "EGFR"
clin_df$Group[clin_df$Tumor_Sample_Barcode %in% kras_samples] <- "KRAS"

# Crear variables OS.time y OS 
surv_df <- clin_df %>%
  filter(Group %in% c("EGFR", "KRAS")) %>%
  mutate(
    # Convertir "Dead" / "Alive" a 1 / 0
    OS = ifelse(vital_status == "Dead", 1, 0),

    # OS.time: muerte o √∫ltimo seguimiento
    OS.time = ifelse(!is.na(days_to_death),
                     days_to_death,
                     days_to_last_followup),

    OS.time = as.numeric(OS.time),
    # Convertir a meses
    OS.time = OS.time / 30.44,

    Group = factor(Group, levels = c("EGFR", "KRAS"))
  ) %>%
  filter(!is.na(OS.time))
